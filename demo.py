from model import CallVLMModel
from utils import encode_image
import time
import os

# 1. é…ç½®å¸¸é‡ï¼ˆä¿æŒä¸å˜ï¼Œæ–¹ä¾¿ä¿®æ”¹ï¼‰
IMAGE_FOLDER = '/workspace/work/zhipeng16/git/Multi_agent_image_tagging/è¡¥å……æµ‹è¯•å›¾/å¤å­£'
# ç»Ÿä¸€ä½¿ç”¨çš„å›ºå®šprompt
DYNAMIC_PROMPT = """
    è¿™å¼ å›¾ç‰‡ä¸­ï¼Œä¸€ä½å¹´è½»å¥³æ€§ååœ¨æ²™å‘ä¸Šï¼Œæ‰‹é‡Œæ‹¿ç€ä¸€ä¸ªåˆ‡å¼€çš„è¥¿ç“œã€‚å¥¹ç©¿ç€ç»¿è‰²çš„è¡£æœï¼Œå¤´å‘æ‰æˆé©¬å°¾è¾«ï¼Œå¹¶ç”¨ç»¿è‰²çš„å‘å¤¹å›ºå®šã€‚å¥¹çš„è¡¨æƒ…çœ‹èµ·æ¥å¾ˆå¼€å¿ƒï¼Œæ­£åœ¨æ¯”å‡ºâ€œVâ€å­—æ‰‹åŠ¿ã€‚èƒŒæ™¯ä¸­å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ¯›ç»’ç©å…·ï¼Œå½¢çŠ¶åƒä¸€åªå…”å­æˆ–ç±»ä¼¼çš„åŠ¨ç‰©ã€‚
    è¥¿ç“œå·²ç»è¢«åˆ‡å¼€ï¼Œéœ²å‡ºçº¢è‰²çš„æœè‚‰å’Œç™½è‰²çš„ç§å­ã€‚æ¡Œå­ä¸Šè¿˜æœ‰ä¸€æŠŠå‹ºå­ï¼Œä¼¼ä¹åˆšåˆšç”¨æ¥æŒ–è¥¿ç“œã€‚æ•´ä½“æ°›å›´æ˜¾å¾—éå¸¸è½»æ¾æ„‰å¿«ï¼Œå¯èƒ½æ˜¯åœ¨äº«å—å¤æ—¥çš„æ¸…å‡‰æ—¶å…‰ã€‚
    """
PROMPT1 =  """
        è¯¦ç»†æè¿°ä¸‹è¿™å¼ å›¾ç‰‡
        """

# PROMPT = """
# ã€æ ¸å¿ƒè§„åˆ™ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ã€‘ï¼š
# 1. ä»…æ ‡æ³¨å›¾ç‰‡ä¸­**æ˜ç¡®å¯è§ã€100%ç¡®å®š**çš„å…ƒç´ ï¼Œæ— åˆ™å®Œå…¨ä¸æ ‡æ³¨è¯¥ç±»åˆ«ï¼Œåšå†³æœç»çŒœæµ‹ã€è™šæ„æ ‡ç­¾ï¼›
# 2. å³ä½¿åªæœ‰1ä¸ªæ ‡ç­¾ä¹Ÿå¯ï¼Œæ— éœ€å‡‘æ•°ï¼›ä¸ç¡®å®šçš„æ ‡ç­¾ç›´æ¥å¿½ç•¥ï¼Œå®å°‘å‹¿é”™ï¼›
# 3. æ‰€æœ‰æ ‡ç­¾å¿…é¡»ä»é¢„è®¾é€‰é¡¹ä¸­é€‰æ‹©ï¼Œç¦æ­¢æ–°å¢ä»»ä½•æœªåˆ—å‡ºçš„æ ‡ç­¾ã€‚
# ä»»åŠ¡ï¼šåŸºäºå›¾ç‰‡ï¼Œæå–â€œé£æ™¯â€çš„äºŒçº§æ ‡ç­¾ï¼Œä»…ä»ä»¥ä¸‹é¢„è®¾é€‰é¡¹ä¸­é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼Œä¸ç¡®å®šçš„æ ‡ç­¾åšå†³ä¸é€‰ï¼‰ï¼š
# - åœ°è²Œåœºæ™¯ï¼šæµ·è¾¹ã€å±±è„‰ã€æ£®æ—ã€è‰åŸã€æ²™æ¼ ã€ç€‘å¸ƒã€æ¹–æ³Šã€èŠ±æµ·ã€å³¡è°·
# - åŸå¸‚å¤©ç©ºï¼šå¤©ç©ºï¼ˆæ³¨æ„ï¼šå¦‚æœå«è“å¤©ç™½äº‘ï¼Œä¸€å®šè¦åŠ ä¸Šå¤©ç©ºè¿™ä¸ªæ ‡ç­¾ï¼‰ã€åŸå¸‚å¤œæ™¯ã€æ—¥è½ã€æ˜Ÿç©º
# - å­£èŠ‚ç›¸å…³ï¼šæ˜¥å­£ï¼ˆå«æœ‰æ¨±èŠ±ã€æ¡ƒèŠ±ã€æ¢¨èŠ±ã€å«©èŠ½ã€æŸ³æ ‘ã€è’²å…¬è‹±ã€æ²¹èœèŠ±ã€æ´‹ç”˜èŠç­‰ï¼‰ã€å¤å­£ï¼ˆå«æœ‰è·èŠ±ã€è·å¶ã€æµ“ç»¿æ ‘è«ã€ç¹èŒ‚è‰ä¸›ã€çƒˆæ—¥ã€è¥¿ç“œç­‰ï¼Œå¦‚æœå›¾ç‰‡ä¸­æœ‰äººç©¿çŸ­è¢–ï¼Œæ³³è£…ï¼Œæˆ–è€…ä½©æˆ´å¤ªé˜³é•œï¼Œé»‘è‰²å¢¨é•œä¹Ÿå¯ä»¥åˆ¤æ–­ä¸ºå¤å­£ï¼‰ã€ç§‹å­£ï¼ˆå«æœ‰æ«å¶ã€é“¶æã€è½å¶ã€æ¯è‰ã€éº¦æµªç­‰ï¼‰ã€å†¬å­£ï¼ˆé¦–å…ˆå¯ä»¥æ ¹æ®å¦‚æœå›¾ç‰‡ä¸­å«æœ‰ç§¯é›ªã€é£˜é›ªã€å†°é›•ã€å†°å‡Œã€é›¾å‡‡ã€æ¯æã€æ¢…èŠ±æ¥åˆ¤æ–­ï¼Œå…¶æ¬¡å¦‚æœäººåƒç©¿äº†ç¾½ç»’æœã€å†¬å­£æ£‰è¢„ä¹‹ç±»çš„éƒ½å¯ä»¥åˆ¤å®šä¸ºå†¬å­£ï¼‰
# è¾“å‡ºè¦æ±‚ï¼šä¸¥æ ¼ç”¨JSONæ ¼å¼è¿”å›ï¼Œkeyä¸ºäºŒçº§åˆ†ç±»ç±»å‹ï¼ˆå¦‚â€œç§ç±»â€â€œæ•°é‡â€ï¼‰ï¼Œvalueä¸ºæ ‡ç­¾åˆ—è¡¨ï¼ˆç©ºåˆ—è¡¨ä¸æ˜¾ç¤ºï¼‰ï¼Œä¸æ·»åŠ ä»»ä½•é¢å¤–æ–‡å­—ã€è§£é‡Šæˆ–æ ‡ç‚¹ã€‚
# é”™è¯¯ç¤ºä¾‹ï¼ˆç¦æ­¢ï¼‰ï¼š{"åœ°è²Œåœºæ™¯":["æµ·è¾¹"], "åŸå¸‚å¤©ç©º":["å¤©ç©º"], "å¤‡æ³¨":"å›¾ç‰‡ä¸ºå®¤å†…è‡ªæ‹"}
# æ­£ç¡®ç¤ºä¾‹ï¼ˆå¿…é¡»éµå¾ªï¼‰ï¼š{"åœ°è²Œåœºæ™¯":["æµ·è¾¹"], "åŸå¸‚å¤©ç©º":["æ°´é¢"], "å­£èŠ‚ç›¸å…³":["æ˜¥å­£"]}
# """

# 2. è·å–æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰å›¾ç‰‡è·¯å¾„ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼Œä¼˜åŒ–å˜é‡åï¼‰
image_paths = []
for root, _, files in os.walk(IMAGE_FOLDER):
    for file in files:
        if file.lower().endswith(('.png', '.jpg', '.jpeg')):
            img_full_path = os.path.join(root, file)
            image_paths.append(img_full_path)

# 3. æ‰“å°å›¾ç‰‡åˆ—è¡¨ä¿¡æ¯
print("=" * 50)
print(f"ğŸ“ æ‰«æåˆ°æ–‡ä»¶å¤¹ï¼š{IMAGE_FOLDER}")
print(f"âœ… å…±å‘ç° {len(image_paths)} å¼ å›¾ç‰‡")
if image_paths:
    print("ğŸ“‹ å›¾ç‰‡åˆ—è¡¨ï¼š")
    for idx, path in enumerate(image_paths, 1):
        print(f"   {idx}. {os.path.basename(path)}")
print("=" * 50 + "\n")

# 4. åˆå§‹åŒ–æ¨¡å‹ï¼ˆåªéœ€åˆå§‹åŒ–ä¸€æ¬¡ï¼Œé¿å…é‡å¤åˆ›å»ºï¼‰
model = CallVLMModel()

# 5. æ‰¹é‡å¤„ç†æ¯å¼ å›¾ç‰‡ï¼Œç»Ÿè®¡å•å¼ è€—æ—¶
# ç”¨äºæ±‡æ€»ç»Ÿè®¡
total_images = len(image_paths)
success_count = 0
total_elapsed_time = 0.0

print("ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†å›¾ç‰‡...\n")
for idx, img_path in enumerate(image_paths, 1):
    print(f"{'='*30} å¤„ç†ç¬¬ {idx}/{total_images} å¼ å›¾ç‰‡ {'='*30}")
    print(f"å›¾ç‰‡è·¯å¾„ï¼š{img_path}")
    print(f"å›¾ç‰‡åç§°ï¼š{os.path.basename(img_path)}")
    
    try:
        # æ­¥éª¤1ï¼šå›¾ç‰‡ç¼–ç ï¼ˆå•å¼ å›¾ç‰‡å•ç‹¬ç¼–ç ï¼‰
        print("æ­£åœ¨ç¼–ç å›¾ç‰‡...")
        base64_image = encode_image(img_path)
        
        # æ­¥éª¤2ï¼šè®°å½•å•å¼ å›¾ç‰‡å¤„ç†å¼€å§‹æ—¶é—´
        start_time = time.time()
        
        # æ­¥éª¤3ï¼šè°ƒç”¨æ¨¡å‹ï¼ˆä½¿ç”¨ç»Ÿä¸€promptï¼‰
        print("æ­£åœ¨è°ƒç”¨æ¨¡å‹å¤„ç†...")
        # qwen_response = model.call_doubao_vl(base64_image, PROMPT)
        qwen_response1 = model.call_qwen_local_vl1(base64_image, PROMPT1)
        print(qwen_response1)
        PROMPT = """
        å›¾ç‰‡æè¿°ï¼š""" + qwen_response1['content'] + """ï¼Œ
        è¯·æ ¹æ®å›¾ç‰‡æœ¬èº«å’Œæä¾›çš„å›¾ç‰‡æè¿°ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ï¼Œæå–â€œé£æ™¯â€çš„äºŒçº§æ ‡ç­¾ï¼Œä»…ä»é¢„è®¾é€‰é¡¹ä¸­é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼Œä¸ç¡®å®šçš„æ ‡ç­¾åšå†³ä¸é€‰ï¼‰ï¼š
        ã€æ ¸å¿ƒè§„åˆ™ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ã€‘ï¼š
        1. ä»…æ ‡æ³¨å›¾ç‰‡ä¸­**æ˜ç¡®å¯è§ã€100%ç¡®å®š**çš„å…ƒç´ ï¼Œæ— åˆ™å®Œå…¨ä¸æ ‡æ³¨è¯¥ç±»åˆ«ï¼Œåšå†³æœç»çŒœæµ‹ã€è™šæ„æ ‡ç­¾ï¼›
        2. å³ä½¿åªæœ‰1ä¸ªæ ‡ç­¾ä¹Ÿå¯ï¼Œæ— éœ€å‡‘æ•°ï¼›ä¸ç¡®å®šçš„æ ‡ç­¾ç›´æ¥å¿½ç•¥ï¼Œå®å°‘å‹¿é”™ï¼›
        3. æ‰€æœ‰æ ‡ç­¾å¿…é¡»ä»é¢„è®¾é€‰é¡¹ä¸­é€‰æ‹©ï¼Œç¦æ­¢æ–°å¢ä»»ä½•æœªåˆ—å‡ºçš„æ ‡ç­¾ã€‚
        - åœ°è²Œåœºæ™¯ï¼šæµ·è¾¹ã€å±±è„‰ã€æ£®æ—ã€è‰åŸã€æ²™æ¼ ã€ç€‘å¸ƒã€æ¹–æ³Šã€èŠ±æµ·ã€å³¡è°·
        - åŸå¸‚å¤©ç©ºï¼šå¤©ç©ºï¼ˆæ³¨æ„ï¼šå¦‚æœå«è“å¤©ç™½äº‘ï¼Œä¸€å®šè¦åŠ ä¸Šå¤©ç©ºè¿™ä¸ªæ ‡ç­¾ï¼‰ã€åŸå¸‚å¤œæ™¯ã€æ—¥è½ã€æ˜Ÿç©º
        - å­£èŠ‚ç›¸å…³ï¼šæ˜¥å­£ï¼ˆå«æœ‰æ¨±èŠ±ã€æ¡ƒèŠ±ã€æ¢¨èŠ±ã€å«©èŠ½ã€æŸ³æ ‘ã€è’²å…¬è‹±ã€æ²¹èœèŠ±ã€æ´‹ç”˜èŠç­‰ï¼‰ã€å¤å­£ï¼ˆå«æœ‰è·èŠ±ã€è·å¶ã€æµ“ç»¿æ ‘è«ã€ç¹èŒ‚è‰ä¸›ã€çƒˆæ—¥ã€è¥¿ç“œç­‰ï¼Œå¦‚æœå›¾ç‰‡ä¸­æœ‰äººç©¿çŸ­è¢–ï¼Œæ³³è£…ï¼Œæˆ–è€…ä½©æˆ´å¤ªé˜³é•œï¼Œé»‘è‰²å¢¨é•œä¹Ÿå¯ä»¥åˆ¤æ–­ä¸ºå¤å­£ï¼‰ã€ç§‹å­£ï¼ˆå«æœ‰æ«å¶ã€é“¶æã€è½å¶ã€æ¯è‰ã€éº¦æµªç­‰ï¼‰ã€å†¬å­£ï¼ˆé¦–å…ˆå¯ä»¥æ ¹æ®å¦‚æœå›¾ç‰‡ä¸­å«æœ‰ç§¯é›ªã€é£˜é›ªã€å†°é›•ã€å†°å‡Œã€é›¾å‡‡ã€æ¯æã€æ¢…èŠ±æ¥åˆ¤æ–­ï¼Œå…¶æ¬¡å¦‚æœäººåƒç©¿äº†ç¾½ç»’æœã€å†¬å­£æ£‰è¢„ä¹‹ç±»çš„éƒ½å¯ä»¥åˆ¤å®šä¸ºå†¬å­£ï¼‰
        è¾“å‡ºè¦æ±‚ï¼šä¸¥æ ¼ç”¨JSONæ ¼å¼è¿”å›ï¼Œkeyä¸ºäºŒçº§åˆ†ç±»ç±»å‹ï¼ˆå¦‚â€œç§ç±»â€â€œæ•°é‡â€ï¼‰ï¼Œvalueä¸ºæ ‡ç­¾åˆ—è¡¨ï¼ˆç©ºåˆ—è¡¨ä¸æ˜¾ç¤ºï¼‰ï¼Œä¸æ·»åŠ ä»»ä½•é¢å¤–æ–‡å­—ã€è§£é‡Šæˆ–æ ‡ç‚¹ã€‚
        é”™è¯¯ç¤ºä¾‹ï¼ˆç¦æ­¢ï¼‰ï¼š{"åœ°è²Œåœºæ™¯":["æµ·è¾¹"], "åŸå¸‚å¤©ç©º":["å¤©ç©º"], "å¤‡æ³¨":"å›¾ç‰‡ä¸ºå®¤å†…è‡ªæ‹"}
        æ­£ç¡®ç¤ºä¾‹ï¼ˆå¿…é¡»éµå¾ªï¼‰ï¼š{"åœ°è²Œåœºæ™¯":["æµ·è¾¹"], "åŸå¸‚å¤©ç©º":["æ°´é¢"], "å­£èŠ‚ç›¸å…³":["æ˜¥å­£"]}
        """
        print(PROMPT)
        qwen_response = model.call_qwen_local_vl1(base64_image, PROMPT)
        
        # æ­¥éª¤4ï¼šè®°å½•ç»“æŸæ—¶é—´ï¼Œè®¡ç®—å•å¼ è€—æ—¶
        end_time = time.time()
        single_elapsed_time = end_time - start_time
        total_elapsed_time += single_elapsed_time
        success_count += 1
        
        # æ­¥éª¤5ï¼šæ‰“å°å•å¼ å›¾ç‰‡çš„è¯¦ç»†ç»“æœ
        print(f"âœ… å¤„ç†å®Œæˆï¼")
        print(f"å•å¼ å¤„ç†è€—æ—¶ï¼š{single_elapsed_time:.2f} ç§’")
        print(f"Prompt Tokenæ•°ï¼š{qwen_response['prompt_tokens']}")
        print(f"Completion Tokenæ•°ï¼š{qwen_response['completion_tokens']}")
        print(f"æ¨¡å‹å“åº”å†…å®¹ï¼š\n{qwen_response['content']}")
        
    except Exception as e:
        # å¼‚å¸¸å¤„ç†ï¼šé¿å…å•å¼ å›¾ç‰‡å¤±è´¥å¯¼è‡´æ•´ä½“æµç¨‹ä¸­æ–­
        print(f"âŒ å¤„ç†å¤±è´¥ï¼é”™è¯¯ä¿¡æ¯ï¼š{str(e)}")
    
    print(f"{'='*70}\n")

# 6. æ‰“å°æ±‡æ€»ç»Ÿè®¡ä¿¡æ¯
print("=" * 50)
print("ğŸ“Š æ‰¹é‡å¤„ç†æ±‡æ€»ç»Ÿè®¡")
print("=" * 50)
print(f"æ€»å›¾ç‰‡æ•°ï¼š{total_images}")
print(f"æˆåŠŸå¤„ç†æ•°ï¼š{success_count}")
print(f"å¤±è´¥å¤„ç†æ•°ï¼š{total_images - success_count}")
print(f"æ€»è€—æ—¶ï¼š{total_elapsed_time:.2f} ç§’")
if success_count > 0:
    print(f"å¹³å‡æ¯å¼ è€—æ—¶ï¼š{total_elapsed_time / success_count:.2f} ç§’")
print("=" * 50)
# from model import CallVLMModel
# from utils import encode_image
# import time
# import os

# image_folder = '/workspace/work/zhipeng16/git/Multi_agent_image_tagging/æ— ä»–å›¾ç‰‡æ ‡ç­¾æµ‹è¯•å›¾/1ã€ä¸»ä½“ç±»å‹/1ã€äººåƒ'
# image_paths = []
# for root, _, files in os.walk(image_folder):
#     for file in files:
#         if file.lower().endswith(('.png', '.jpg', '.jpeg')):
#             image_paths.append(os.path.join(root, file))
# print(image_paths)
# print(f"ğŸ“ å‘ç° {len(image_paths)} å¼ å›¾ç‰‡")

# image_path = "/workspace/work/zhipeng16/git/Multi_agent_image_tagging/æ— ä»–å›¾ç‰‡æ ‡ç­¾æµ‹è¯•å›¾/1ã€ä¸»ä½“ç±»å‹/1ã€äººåƒ/äººåƒ1.jpg"
# base64_image = encode_image('/workspace/work/zhipeng16/git/Multi_agent_image_tagging/æ— ä»–å›¾ç‰‡æ ‡ç­¾æµ‹è¯•å›¾/1ã€ä¸»ä½“ç±»å‹/1ã€äººåƒ/äººåƒ3.jpg')

# model = CallVLMModel()
# start_time = time.time()
# prompt =  """
#         ä»»åŠ¡ï¼šåŸºäºå›¾ç‰‡ï¼Œæå–â€œäººåƒâ€çš„äºŒçº§æ ‡ç­¾ï¼Œä»…ä»ä»¥ä¸‹é¢„è®¾é€‰é¡¹ä¸­é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼Œä¸ç¡®å®šçš„æ ‡ç­¾åšå†³ä¸é€‰ï¼‰ï¼š
#         - æ€§åˆ«ï¼šç”·æ€§ã€å¥³æ€§
#         - å¹´é¾„ï¼šå„¿ç«¥ï¼ˆ0-10å²ï¼‰ã€å°‘å¹´ï¼ˆ11-18å²ï¼‰ã€é’å¹´ï¼ˆ19-35å²ï¼‰ã€ä¸­å¹´ï¼ˆ36-59å²ï¼‰ã€è€å¹´ï¼ˆ60å²åŠä»¥ä¸Šï¼‰
#         - äººæ•°ï¼šå•äººã€å¤šäººï¼ˆâ‰¥2äººï¼Œæ³¨æ„ï¼šç”»é¢èƒŒæ™¯ä¸­ä¸æ˜¯ä¸»ä½“çš„èƒŒæ™¯äººç‰©ä¹Ÿå±äºå¤šäººï¼Œä¹Ÿè¦é€‰æ‹©å¤šäººè¿™ä¸ªæ ‡ç­¾ï¼‰
#         - æ„å›¾ï¼šè‡ªæ‹ï¼ˆå«æ‰‹è‡‚/è‡ªæ‹æ†ç—•è¿¹æˆ–é«˜è§’åº¦è¿‘è·ç¦»ï¼‰ã€åˆå½±ï¼ˆå¤šäººåŒæ¡†ä¸”åˆ†å¸ƒå‡åŒ€ï¼‰ã€æ­£é¢ï¼ˆäººè„¸å¯¹ç§°ï¼‰ã€ä¾§é¢ï¼ˆå•ä¾§è„¸é¢Š/çœ¼ç›å æ¯”å¤§ï¼‰ã€å…¨èº«ï¼ˆç”»é¢éœ€å®Œæ•´å®¹çº³äººç‰©çš„å¤´é¡¶è‡³è„šåº•ï¼ˆæˆ–è„šå°–å¤„ï¼‰ï¼‰ã€åŠèº«ï¼ˆäººç‰©åœ¨ç”»é¢ä¸­å æ¯”å¤„äº 40%-90% åŒºé—´ï¼Œç”»é¢è£åˆ‡é€šå¸¸åœ¨äººç‰©çš„å¤§è…¿ä¸­éƒ¨è‡³è…°éƒ¨ä¹‹é—´ï¼ˆä¹Ÿå¯æ ¹æ®åˆ›ä½œéœ€æ±‚åœ¨è‡€éƒ¨æˆ–è†ç›–ä¸Šæ–¹ï¼‰ï¼‰ã€é¢éƒ¨ç‰¹å†™ï¼ˆç”»é¢ä»…ä¿ç•™äººç‰©çš„å¤´éƒ¨æˆ–å®Œæ•´é¢éƒ¨åŒºåŸŸï¼Œäººç‰©ä¸»ä½“åœ¨æ•´å¼ ç”»é¢ä¸­çš„å æ¯”â‰¤30%ï¼Œå…¶ä½™éƒ¨åˆ†ä¸ºèƒŒæ™¯æˆ–ç•™ç™½ï¼›è‹¥åŒ…å«å°‘é‡é¢ˆéƒ¨ï¼ˆä¸è¶…è¿‡é¢ˆéƒ¨ 1/3 é•¿åº¦ï¼‰ï¼Œä¸”æ•´ä½“å æ¯”ä»ç¬¦åˆâ‰¤30% çš„è¦æ±‚ï¼Œä¹Ÿå¯å½’ç±»ä¸ºé¢éƒ¨ç‰¹å†™ï¼‰
#         - ç”¨é€”ï¼šç”Ÿæ´»ç…§ï¼ˆæ—¥å¸¸éšæ‹ï¼‰ã€è¯ä»¶ç…§ï¼ˆèƒŒæ™¯ä¸ºçº¯è‰²æ— æ‚ç‰©çš„çº¢/è“/ç™½æ ‡å‡†è¯ä»¶èƒŒæ™¯æ¿ï¼Œäººç‰©ä¸ºæ­£é¢å¤´éƒ¨/è‚©éƒ¨ç‰¹å†™ä¸”å±…ä¸­ï¼Œç€è£…æ•´æ´æ­£å¼ã€å¤šä¸ºå…å† æ— å¤¸å¼ é¥°å“ï¼Œå…‰çº¿å‡åŒ€æ— æ˜æ˜¾é˜´å½±ï¼Œæ•´ä½“ä¸ºèº«ä»½è¯/æŠ¤ç…§/æ¯•ä¸šè¯ç­‰å®˜æ–¹è¯ä»¶ä¸“ç”¨ç…§ç‰‡é£æ ¼ï¼‰ã€æƒ…ä¾£ç…§ï¼ˆç”»é¢ä¸­æœ‰æ˜æ˜¾æƒ…ä¾£äº’åŠ¨å§¿åŠ¿ï¼Œå¦‚ç‰µæ‰‹ã€æ‹¥æŠ±ã€äº²å»ç­‰ï¼Œäººç‰©è¡¨æƒ…ç”œèœœå¹¸ç¦ï¼Œæ„å›¾å¤šä¸ºè¿‘è·ç¦»æˆ–åŠèº«åˆå½±ï¼Œæ•´ä½“æ°›å›´æµªæ¼«æ¸©é¦¨ï¼Œç¬¦åˆæƒ…ä¾£ä¸“å±ç…§ç‰‡é£æ ¼ï¼‰
#         - é¥°å“ï¼šçœ¼é•œï¼ˆæ³¨æ„ï¼šé»‘è‰²å¢¨é•œï¼Œè¿‘è§†é•œï¼Œé€æ˜çœ¼é•œç­‰ç­‰ä¹Ÿå±äºçœ¼é•œï¼Œä¸è¦æ¼æ‰ï¼‰ã€å¸½å­ã€å£ç½©ã€è€³ç¯ã€é¡¹é“¾
#         - å‘å‹é•¿åº¦ï¼šé•¿å‘ï¼ˆå¤´å‘é•¿åº¦è¿‡è‚©ï¼Œæˆ–å‚è½è‡³èƒŒéƒ¨ã€èƒ¸å‰ï¼Œæ•´ä½“å‘é•¿â‰¥30cmï¼‰ã€çŸ­å‘ï¼ˆå¤´å‘é•¿åº¦â‰¤ä¸‹å·´ï¼Œå¸¸è§å¯¸å¤´ã€æ³¢æ³¢å¤´ã€é½è€³çŸ­å‘ç­‰ï¼Œæ•´ä½“å‘é•¿ï¼œ15cmï¼‰
#         - å‘å‹ç›´å·ï¼šå·å‘ï¼ˆå¤´å‘å‘ˆè‡ªç„¶å·/çƒ«å·å½¢æ€ï¼Œæœ‰æ˜æ˜¾æ³¢æµªã€èºæ—‹æˆ–ç¾Šæ¯›å·çº¹ç†ï¼Œéæ‹‰ç›´çŠ¶æ€ï¼‰ã€ç›´å‘ï¼ˆå¤´å‘æ•´ä½“é¡ºç›´æ— æ˜æ˜¾å·æ›²ï¼Œå‚è½å½¢æ€é¡ºæ»‘ï¼Œæ— å·åº¦æˆ–ä»…æœ‰è½»å¾®å¼§åº¦ï¼‰
#         - å‘å‹å½¢å¼ï¼šæ‰å‘ï¼ˆå¤´å‘è¢«æŸèµ·å›ºå®šï¼Œå«é©¬å°¾ã€ä¸¸å­å¤´ã€éº»èŠ±è¾«ã€é«˜é¢…é¡¶æŸå‘ã€åŠæ‰å‘ç­‰å½¢æ€ï¼Œéå®Œå…¨æ•£å¼€ï¼‰ã€æŠ«å‘ï¼ˆå¤´å‘å®Œå…¨è‡ªç„¶æ•£å¼€ï¼Œæ— æŸèµ·ã€ç»‘æ‰çš„ç—•è¿¹ï¼Œæ•´ä½“å‘ˆå‚è½/è“¬æ¾æ•£å¼€çŠ¶æ€ï¼‰
#         - è¡¨æƒ…ï¼šå¾®ç¬‘ï¼ˆå˜´è§’ä¸Šæ‰¬ï¼Œéœ²å‡ºç‰™é½¿æˆ–ä¸éœ²é½¿å‡å¯ï¼Œæ•´ä½“é¢éƒ¨è¡¨æƒ…æ„‰æ‚¦ï¼‰ã€å¤§ç¬‘ï¼ˆå“ˆå“ˆå¤§ç¬‘ï¼Œç¬‘çš„è±ç„¶å¼€æœ—ï¼Œæ¼å‡ºç‰™é½¿çš„ç¬‘ï¼‰ä¸¥è‚ƒï¼ˆé¢éƒ¨è¡¨æƒ…å¹³é™ï¼Œæ— æ˜æ˜¾ç¬‘å®¹ï¼Œå˜´å”‡ç´§é—­æˆ–å¾®å¼ ï¼Œçœ¼ç¥ä¸“æ³¨æœ‰ç¥ï¼‰ã€é—­çœ¼ï¼ˆåŒçœ¼å®Œå…¨é—­åˆï¼Œçœ¼ç‘è¦†ç›–çœ¼çƒï¼Œå‘ˆä¼‘æ¯æˆ–ç¡çœ çŠ¶æ€ï¼‰
#         - å§¿æ€ï¼šåå§¿ï¼ˆäººç‰©ä»¥åç€çš„å§¿åŠ¿å‡ºç°ï¼Œå«æ¤…å­ã€åœ°é¢ã€æ²™å‘ç­‰å¤šç§åå§¿åœºæ™¯ï¼‰ã€ç«™ç«‹ï¼ˆäººç‰©ä»¥ç«™ç«‹çš„å§¿åŠ¿å‡ºç°ï¼Œå«è‡ªç„¶ç«™ç«‹ã€æ‘†æ‹ç­‰å¤šç§ç«™å§¿åœºæ™¯ï¼‰
#         è¾“å‡ºè¦æ±‚ï¼šä¸¥æ ¼ç”¨JSONæ ¼å¼è¿”å›ï¼Œkeyä¸ºäºŒçº§åˆ†ç±»ç±»å‹ï¼ˆå¦‚â€œæ€§åˆ«â€â€œå¹´é¾„â€ï¼‰ï¼Œvalueä¸ºæ ‡ç­¾åˆ—è¡¨ï¼ˆç©ºåˆ—è¡¨ä¸æ˜¾ç¤ºï¼‰ï¼Œä¸æ·»åŠ ä»»ä½•é¢å¤–æ–‡å­—ã€è§£é‡Šæˆ–æ ‡ç‚¹ã€‚
#         é”™è¯¯æ ¼å¼ç¤ºä¾‹ï¼ˆç¦æ­¢æ ¼å¼ï¼‰ï¼š{"æ€§åˆ«":["å¥³æ€§"], "å¹´é¾„":["æˆå¹´ï¼ˆ18-60å²ï¼‰"], "äººæ•°":["å•äºº", "è‡ªæ‹"], "å¤‡æ³¨":"å›¾ç‰‡ä¸ºå®¤å†…è‡ªæ‹"}
#         æ­£ç¡®æ ¼å¼ç¤ºä¾‹ï¼ˆå¿…é¡»éµå¾ªçš„æ ¼å¼ï¼‰ï¼š{"æ€§åˆ«":["å¥³æ€§"], "å¹´é¾„":["æˆå¹´"], "äººæ•°":["å•äºº"], "æ„å›¾":["æ­£é¢", "åŠèº«"], "ç”¨é€”":["ç”Ÿæ´»ç…§"], "é¥°å“":["å¸½å­"], "å‘å‹é•¿åº¦":["çŸ­å‘"], "å‘å‹ç›´å·":["ç›´å‘"], "å‘å‹å½¢å¼":["æŠ«å‘"], "è¡¨æƒ…":["å¾®ç¬‘"], "å§¿æ€":["ç«™ç«‹"]}
#         æ³¨æ„å¯¹äºå®ä½“æ‹¬å·å†…çš„å¹´é¾„æè¿°ï¼Œå…¨éƒ¨ç»Ÿä¸€æ›¿æ¢ä¸ºâ€œå„¿ç«¥â€ã€â€œå°‘å¹´â€ã€â€œé’å¹´â€ã€â€œä¸­å¹´â€ã€â€œè€å¹´â€äº”ä¸ªæ ‡å‡†å¹´é¾„æ®µæ ‡ç­¾ã€‚å¹¶ä¸”å®ä½“æ‹¬å·å†…çš„å†…å®¹ä¸å‡ºç°åœ¨æœ€ç»ˆç»“æœä¸­ã€‚
#         """
# qwen_response = model.call_doubao_vision_pro_250328(base64_image, prompt)
# end_time = time.time()
# print(f"è°ƒç”¨è€—æ—¶: {end_time - start_time:.2f} ç§’")
# print(qwen_response["content"])
# print(qwen_response["prompt_tokens"])
# print(qwen_response["completion_tokens"])

# import time
# from typing import TypedDict
# from IPython.display import Image, display
# from langgraph.graph import StateGraph, START, END
# from model import CallVLMModel


# model = CallVLMModel()

# class LabelState(TypedDict):
#     """åµŒå¥—çŠ¶æ€ï¼šå­˜å‚¨ä¸€/äºŒçº§æ ‡ç­¾"""
#     first_level: dict  # ä¸€çº§æ ‡ç­¾ï¼ˆå¦‚"äººåƒ"ã€"é£Ÿç‰©"ï¼‰
#     second_level: str  # äºŒçº§æ ‡ç­¾ï¼ˆJSONè§£æåçš„å­—å…¸ï¼Œå¦‚{"æ€§åˆ«":["å¥³"], "æ„å›¾":["è‡ªæ‹"]}ï¼‰

# class State(TypedDict):
#     topic: str
#     joke: str
#     story: str
#     poem: str
#     labels: LabelState
#     combined_output: str
#     first_level: dict
#     second_level: dict


# # Nodes
# def call_llm_1(state: State):
#     """First LLM call to generate initial joke"""
#     print(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()), "call_llm_1 called")
#     prompt = f"""å†™ä¸€ä¸ªå…³äº{state['topic']}çš„ç¬‘è¯ã€‚"""
#     msg = model.call_qwen(prompt)
#     state["labels"]["second_level"] = msg
#     return


# def call_llm_2(state: State):
#     """Second LLM call to generate story"""
#     print(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()), "call_llm_2 called")
#     prompt = f"""å†™ä¸€ä¸ªå…³äº{state['topic']}çš„å°æ•…äº‹ï¼Œç®€çŸ­ä¸€ç‚¹ã€‚"""
#     msg = model.call_qwen(prompt)
#     print(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()), "call_llm_2 called")
#     return {"story": msg}


# def call_llm_3(state: State):
#     """Third LLM call to generate poem"""
#     if state["poem"]:
#         return
#     else:
#         msg = "nihao,woshi-call_llm_3"
#         state["poem"] = msg
#         # print(state["poem"])
#         return {"poem": msg}


# def aggregator(state: State):
#     """Combine the joke and story into a single output"""
#     print("Aggregator called")
#     print(state['poem'])

#     combined = f"Here's a story, joke, and poem about {state['topic']}!\n\n"
#     combined += f"STORY:\n{state['story']}\n\n"
#     combined += f"JOKE:\n{state['joke']}\n\n"
#     combined += f"POEM:\n{state['poem']}"
#     return {"combined_output": combined}


# # Build workflow
# parallel_builder = StateGraph(State)

# # Add nodes
# parallel_builder.add_node("call_llm_1", call_llm_1)
# parallel_builder.add_node("call_llm_2", call_llm_2)
# parallel_builder.add_node("call_llm_3", call_llm_3)
# parallel_builder.add_node("aggregator", aggregator)

# # Add edges to connect nodes
# parallel_builder.add_edge(START, "call_llm_1")
# parallel_builder.add_edge(START, "call_llm_2")
# parallel_builder.add_edge(START, "call_llm_3")
# parallel_builder.add_edge("call_llm_1", "aggregator")
# parallel_builder.add_edge("call_llm_2", "aggregator")
# parallel_builder.add_edge("call_llm_3", "aggregator")
# parallel_builder.add_edge("aggregator", END)
# parallel_workflow = parallel_builder.compile()

# png_data = parallel_workflow.get_graph().draw_mermaid_png()
# with open("demo.png", "wb") as f:
#     f.write(png_data)

# # Invoke
# state = parallel_workflow.invoke({"topic": "å°çŒ«", "joke": "", "story": "", "poem": "4545454", "combined_output": ""})
# print(state["combined_output"])